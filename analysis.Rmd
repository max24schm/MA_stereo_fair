---
title: "Master's Thesis Analysis"
author: "Maximilian Schmidt"
date: "2023-04-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages and Notes
The initial code for data analysis was structured and written according to the analysis plan. Any analyses that were conducted later based on the results of the planned analyses were labelled as additional.
The packages `data.table` and `dplyr` were used for data wrangling and simple preliminary summary statistics.
With the `report`package, the automated report of statistical specifications, tests and their results will be carried out for this analysis. Thereby, errors due to typos or an incomplete reporting of statistical measures are avoided.

```{r for-readers, echo=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(haven)
library(data.table)
library(car)
library(lmerTest)
library(lavaan)
library(report)
library(dplyr)
```

## Data Preparation
The data sets of studies 1-5 were loaded and checked for the correct data formats, etc.
### Study 1
*Prolific IDs were checked for duplicates, one was found: from 800 to 798 rows
*Variables from the 'Observed' and 'Observed by group' conditions were omitted
*Rows from condition 1 ('Private') only were included
*Variables were prepared for the analysis
*Transformation of groups 1-16 from wide to long format
```{r dataprep, echo=FALSE, warning=FALSE, error=FALSE}
path = "C:/Users/Max/Documents/Uni/02 Master/Masterarbeit/Daten_MA/"
data_raw = haven::read_sav(paste0(path,"Study1_anonymous.sav"))
head(data_raw)
length(unique(data_raw$PID_before)) # 799 instead of 800!
data <- data.table::as.data.table(data_raw)
data <- data[!PID_before %in% data[which(duplicated(data$PID_before)),PID_before][1]] # exclude rows with same PID --> now 798 unique rows
data<- data |> dplyr::select(!dplyr::contains(c("Observed", "ByGroup", "Reviewer"))) # if R version below 4.1.0 is used, old pipe needs to be used here: %>% # exclude variables from other conditions
data <- data[Condition %in% "1"] # 267 rows
all(complete.cases(data)) # TRUE

data[, a_mean := round((A_after/10),2)]  # participants' self-rated agency 
data[, b_mean := round((B_after/10),2)]  # participants' self-rated beliefs

data_long = melt(data, measure = patterns("Ident_", "Private_", "(a_g[1-9]|a_g[1-9][0-9])", "(b_g[1-9]|b_g[1-9][0-9])"), value.name = c("g_ident", "allocation", "group_a", "group_b"))
nrow(data_long[variable == 1]) # 267
data_long[,soc_group := variable] 

#     belief 
#1 blck 5.49
#2 wht 4.56
#3 poor 5.18
#4 mid 4.85
#5 rich 3.82
#6 hisp 5.04
#7 asia 5.26
#8 dem 7.62
#9 rep 2.15
#10 gay 8.03
#11 chr 2.03
#12 lib 8.6
#13 cons 1.52
#14 work 4.37
#15 trans 7.99
#16 old 3.02 

# TODO: Similarity variable as the difference between person a/b and group a/b

# library(data.table) # code below only works when the package is loaded, since .N and .() cannot be retrieved from the package using ::
#datab[,.(.N,mw=round(mean(datab$freunde,na.rm = T),2)), by = c("sport.jn", "bochum")]


```


## Descriptive Statistics
```{r descriptives, echo=TRUE, warning=FALSE, error=FALSE}
# check mean and variance in sample's agency and beliefs, also describe the 16 groups
```

## Analyses Study 1
IV: dist_B x group_A 
DV: cents
Control: similarity_AB
Random: ID x group
```{r study1, echo=TRUE, warning=FALSE, error=FALSE}
# assumptions
# normality (residuals)
#assumption_test_1 <- lm(DV ~ IV)
#car::qqPlot(assumption_test_1)
# homoscedasticity
#ncvTest(assumption_test_1)
# graphic analysis
#par(mfrow = c(2,2))
#plot(assumption_test_1)

model_1 <- lmerTest::lmer(cents ~ dist_B * group_A + similarity_AB + (1|ID) + (1|group), data = dat_study_1)

summary(model_1)
report::report(model_1)

# einmal rechnen ohne similarity, einmal mit und ohne Interaktion?
```

## Analyses Study 2
IV: dist_B x principle (factor w 7 levels) 
DV: agreement
Control: similarity_AB
Random: ID x group
```{r study2, echo=TRUE, warning=FALSE, error=FALSE}
model_2 <- lmerTest::lmer(agreement ~ dist_B * principle + similarity_AB + (1|ID) + (1|group), data = dat_study_2)

```

## Analyses Study 3
```{r study3, echo=TRUE, warning=FALSE, error=FALSE}
# a person's beliefs predict their choice of distribution
model_3 <- lmerTest::lmer(choice ~ dist_B + (1|ID), data = dat_study_3)
# path analysis
model4 = 'need ~ a*dist_B
          fair ~ b*need + c*dist_B
          ab := a*b
          total := c + (a*b)'
mfit = lavaan::sem(model4, data = dat_study_3,
            se = "bootstrap")

lavaan::parameterEstimates(mfit, ci = T, boot.ci.type = "bca.simple", rsquare=T)
summary(mfit)

```

## Analyses Study 4
```{r study4, echo=TRUE, warning=FALSE, error=FALSE}

```

## Analyses Study 5
```{r study5, echo=TRUE, warning=FALSE, error=FALSE}

```
